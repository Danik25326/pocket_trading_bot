name: Generate Trading Signals

on:
  workflow_dispatch:
    inputs:
      language:
        description: 'ĞœĞ¾Ğ²Ğ° Ğ´Ğ»Ñ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ— ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ñ–Ğ²'
        required: true
        default: 'uk'
        type: choice
        options:
          - uk
          - ru
      trigger_source:
        description: 'Ğ”Ğ¶ĞµÑ€ĞµĞ»Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºÑƒ'
        default: 'manual'
        type: string
  schedule:
    - cron: '*/9 * * * *'  # Ğ§Ñ–Ñ‚ĞºĞ¾ ĞºĞ¾Ğ¶Ğ½Ñ– 10 Ñ…Ğ²Ğ¸Ğ»Ğ¸Ğ½

permissions:
  contents: write

jobs:
  generate-signals:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # ğŸ†• ĞĞµ Ğ´Ğ°Ñ” Ğ·Ğ°Ğ²Ğ¸ÑĞ½ÑƒÑ‚Ğ¸
    concurrency:  # ğŸ†• ĞĞµ Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑÑ” Ğ¿Ğ°Ñ€Ğ°Ğ»ĞµĞ»ÑŒĞ½Ñ– Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¸
      group: generate-signals-${{ github.ref }}
      cancel-in-progress: false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Clear all caches
      run: |
        echo "ğŸ§¹ ĞÑ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ ĞºĞµÑˆÑƒ..."
        pip cache purge || echo "ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ pip cache"
        rm -rf ~/.cache/pip 2>/dev/null || true
        echo "âœ… ĞšĞµÑˆ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ¾"
    
    - name: Upgrade pip and install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        if [ -f backend/requirements.txt ]; then
          pip install --no-cache-dir -r backend/requirements.txt
          echo "âœ… Ğ—Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚Ñ– Ğ²ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾"
        else
          echo "âŒ Ğ¤Ğ°Ğ¹Ğ» backend/requirements.txt Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾!"
          exit 1
        fi
    
    - name: Verify Python files exist
      run: |
        echo "ğŸ“‚ ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ğ½Ğ°ÑĞ²Ğ½Ğ¾ÑÑ‚Ñ– Python Ñ„Ğ°Ğ¹Ğ»Ñ–Ğ²..."
        if [ ! -f backend/signal_generator.py ]; then
          echo "âŒ Ğ¤Ğ°Ğ¹Ğ» backend/signal_generator.py Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾!"
          exit 1
        fi
        if [ ! -f backend/groq_analyzer.py ]; then
          echo "âŒ Ğ¤Ğ°Ğ¹Ğ» backend/groq_analyzer.py Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾!"
          exit 1
        fi
        echo "âœ… Ğ’ÑÑ– Python Ñ„Ğ°Ğ¹Ğ»Ğ¸ Ğ½Ğ° Ğ¼Ñ–ÑÑ†Ñ–"
    
    - name: Create necessary directories
      run: |
        echo "ğŸ“ Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ñ–Ğ¹..."
        mkdir -p data logs
        touch .nojekyll
        
        # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ„Ğ°Ğ¹Ğ»Ğ¸, ÑĞºÑ‰Ğ¾ Ñ—Ñ… Ğ½ĞµĞ¼Ğ°Ñ”
        if [ ! -f data/signals.json ]; then 
          echo '{"last_update": null, "signals": [], "timezone": "Europe/Kiev (UTC+2)"}' > data/signals.json
          echo "âœ… Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾ signals.json"
        fi
        if [ ! -f data/history.json ]; then 
          echo '[]' > data/history.json
          echo "âœ… Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾ history.json"
        fi
        if [ ! -f data/assets_config.json ]; then 
          echo '{"preferred_assets": ["GBPJPY_otc", "EURUSD_otc", "USDJPY_otc"]}' > data/assets_config.json
          echo "âœ… Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾ assets_config.json"
        fi
        if [ ! -f data/lessons.json ]; then 
          echo '[]' > data/lessons.json
          echo "âœ… Ğ¡Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾ lessons.json"
        fi
    
    - name: Generate trading signals
      env:
        TZ: 'Europe/Kiev'
        POCKET_SSID: ${{ secrets.POCKET_SSID }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        POCKET_DEMO: 'true'
        SIGNAL_INTERVAL: '600'
        MIN_CONFIDENCE: '0.7'
        MAX_DURATION: '5.0'
        SIGNAL_VALIDITY_MINUTES: '10'
        MAX_SIGNALS_ON_SITE: '6'
        ASSETS: 'GBPJPY_otc,EURUSD_otc,USDJPY_otc'
        TIMEFRAMES: '120'
        LOG_LEVEL: 'INFO'
        GROQ_MODEL: 'openai/gpt-oss-120b'
        LANGUAGE: ${{ inputs.language || 'uk' }}
        TRIGGER_SOURCE: ${{ inputs.trigger_source || 'schedule' }}  # ğŸ†• Ğ—Ğ¼Ñ–Ğ½Ğ¸Ğ² Ğ½Ğ° 'schedule'
      run: |
        echo "ğŸš€ ĞŸĞĞ§ĞĞ¢ĞĞš Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ†Ğ‡ Ğ¡Ğ˜Ğ“ĞĞĞ›Ğ†Ğ’"
        echo "========================================"
        echo "â° Ğ—Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾: $(date '+%Y-%m-%d %H:%M:%S') UTC"
        echo "ğŸ  ĞšĞ¸Ñ—Ğ²ÑÑŒĞºĞ¸Ğ¹ Ñ‡Ğ°Ñ: $(TZ='Europe/Kiev' date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“… ĞĞ°ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº: Ñ‡ĞµÑ€ĞµĞ· 10 Ñ…Ğ²Ğ¸Ğ»Ğ¸Ğ½"
        echo "ğŸŒ ĞœĞ¾Ğ²Ğ°: $LANGUAGE"
        echo "ğŸ“Š ĞĞºÑ‚Ğ¸Ğ²Ğ¸: $ASSETS"
        echo "ğŸ§  AI: $GROQ_MODEL"
        echo "ğŸ”§ Ğ”Ğ¶ĞµÑ€ĞµĞ»Ğ¾: $TRIGGER_SOURCE"
        echo "========================================"
        
        export PYTHONPATH=$PYTHONPATH:$(pwd)/backend:$(pwd):$(pwd)/utils
        
        cd backend
        echo "â–¶ï¸ Ğ—Ğ°Ğ¿ÑƒÑĞº signal_generator.py..."
        python signal_generator.py
        
        echo "âœ… Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° Ğ¾ $(date '+%H:%M:%S') UTC"
        echo "â³ ĞĞ°ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ñ‡ĞµÑ€ĞµĞ· 10 Ñ…Ğ²Ğ¸Ğ»Ğ¸Ğ½"
    
    - name: Verify signals were created
      run: |
        echo "ğŸ” ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ° Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ–Ğ²..."
        if [ -f data/signals.json ]; then
          SIGNALS_COUNT=$(jq '.signals | length' data/signals.json 2>/dev/null || echo "0")
          echo "ğŸ“Š Ğ—Ğ³ĞµĞ½ĞµÑ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ ÑĞ¸Ğ³Ğ½Ğ°Ğ»Ñ–Ğ²: $SIGNALS_COUNT"
          
          if [ "$SIGNALS_COUNT" -gt 0 ]; then
            echo "ğŸ¯ Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»Ğ¸ ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ¾ Ğ·Ğ³ĞµĞ½ĞµÑ€Ğ¾Ğ²Ğ°Ğ½Ñ–!"
          else
            echo "âš ï¸  Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»Ñ–Ğ² Ğ½Ğµ Ğ·Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ (Ğ¼Ğ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾ AI Ğ½Ğµ Ğ¿Ğ¾Ğ²ĞµÑ€Ğ½ÑƒĞ² Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¸)"
          fi
        else
          echo "âŒ Ğ¤Ğ°Ğ¹Ğ» signals.json Ğ½Ğµ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾!"
          exit 1
        fi
    
    - name: Commit and push all changes
      if: success()  # ğŸ†• Ğ¢Ñ–Ğ»ÑŒĞºĞ¸ Ğ¿Ñ€Ğ¸ ÑƒÑĞ¿Ñ–Ñ…Ñƒ
      run: |
        echo "ğŸ’¾ ĞŸÑ–Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²ĞºĞ° Ğ´Ğ¾ ĞºĞ¾Ğ¼Ñ–Ñ‚Ñƒ..."
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
        # Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ²ÑÑ– Ğ·Ğ¼Ñ–Ğ½Ğ¸ Ğ² Ğ´Ğ°Ğ½Ğ¸Ñ…
        git add data/
        git add logs/
        git add .nojekyll
        
        if git diff --staged --quiet; then
          echo "âš ï¸ ĞĞµĞ¼Ğ°Ñ” Ğ·Ğ¼Ñ–Ğ½ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ñ–Ñ‚Ñƒ"
        else
          CURRENT_TIME=$(TZ='Europe/Kiev' date '+%H:%M')
          git commit -m "ğŸ¤– Ğ¡Ğ¸Ğ³Ğ½Ğ°Ğ»Ğ¸: $(date +'%Y-%m-%d %H:%M') [ĞœĞ¾Ğ²Ğ°: ${{ inputs.language || 'uk' }}] [Auto]"
          git push origin main
          echo "âœ… Ğ—Ğ¼Ñ–Ğ½Ğ¸ Ğ·Ğ°ĞºĞ¾Ğ¼Ñ–Ñ‡ĞµĞ½Ğ¾ Ñ‚Ğ° Ğ²Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾"
          echo "ğŸ• Ğ§Ğ°Ñ ĞºĞ¾Ğ¼Ñ–Ñ‚Ñƒ (ĞšĞ¸Ñ—Ğ²): $CURRENT_TIME"
        fi
    
    - name: Log completion time
      if: always()  # ğŸ†• Ğ—Ğ°Ğ²Ğ¶Ğ´Ğ¸ Ğ²Ğ¸ĞºĞ¾Ğ½ÑƒÑ”Ğ¼Ğ¾
      run: |
        echo "========================================"
        echo "ğŸ Ğ—Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾ Ğ¾ $(date '+%H:%M:%S') UTC"
        echo "ğŸ  ĞšĞ¸Ñ—Ğ²ÑÑŒĞºĞ¸Ğ¹ Ñ‡Ğ°Ñ: $(TZ='Europe/Kiev' date '+%H:%M:%S')"
        echo "â³ ĞĞ°ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ñ–Ñ Ñ‡ĞµÑ€ĞµĞ· 10 Ñ…Ğ²Ğ¸Ğ»Ğ¸Ğ½"
        echo "ğŸ“Š ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ĞºĞ°: Actions -> signals.yml"
        echo "ğŸŒ Ğ¡Ğ°Ğ¹Ñ‚: https://danik25326.github.io/pocket_trading_bot/"
        echo "========================================"
