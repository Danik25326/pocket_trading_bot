name: Generate Trading Signals

on:
  workflow_dispatch:
    inputs:
      language:
        description: 'ÐœÐ¾Ð²Ð° Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ— ÑÐ¸Ð³Ð½Ð°Ð»Ñ–Ð²'
        required: true
        default: 'uk'
        type: choice
        options:
          - uk
          - ru
      trigger_source:
        description: 'Ð”Ð¶ÐµÑ€ÐµÐ»Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÑƒ'
        default: 'manual'
        type: string
  schedule:
    - cron: '*/10 * * * *'  # Ð§Ñ–Ñ‚ÐºÐ¾ ÐºÐ¾Ð¶Ð½Ñ– 10 Ñ…Ð²Ð¸Ð»Ð¸Ð½

permissions:
  contents: write

jobs:
  generate-signals:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Clear all caches
      run: |
        echo "ðŸ§¹ ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð½Ñ ÐºÐµÑˆÑƒ..."
        pip cache purge
        rm -rf ~/.cache/pip
        rm -rf ~/.cache/apt
        sudo apt-get clean
        echo "âœ… ÐšÐµÑˆ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ð¾"
    
    - name: Upgrade pip and install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install --no-cache-dir -r backend/requirements.txt
    
    - name: Create necessary directories
      run: |
        mkdir -p data
        mkdir -p logs
        touch .nojekyll
        
        # Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÐ¾Ð²Ñ– Ñ„Ð°Ð¹Ð»Ð¸, ÑÐºÑ‰Ð¾ Ñ—Ñ… Ð½ÐµÐ¼Ð°Ñ”
        if [ ! -f data/signals.json ]; then 
          echo '{"last_update": null, "signals": [], "timezone": "Europe/Kiev (UTC+2)"}' > data/signals.json
        fi
        if [ ! -f data/history.json ]; then 
          echo '[]' > data/history.json
        fi
        if [ ! -f data/assets_config.json ]; then 
          echo '{"preferred_assets": ["GBPJPY_otc", "EURUSD_otc", "USDJPY_otc"]}' > data/assets_config.json
        fi
        if [ ! -f data/lessons.json ]; then 
          echo '[]' > data/lessons.json
        fi
    
    - name: Generate trading signals
      env:
        POCKET_SSID: ${{ secrets.POCKET_SSID }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        POCKET_DEMO: 'true'
        SIGNAL_INTERVAL: '600'  # 10 Ñ…Ð²Ð¸Ð»Ð¸Ð½
        MIN_CONFIDENCE: '0.7'
        MAX_DURATION: '5.0'
        SIGNAL_VALIDITY_MINUTES: '10'  # Ð¡Ð¸Ð³Ð½Ð°Ð»Ð¸ Ð·Ð½Ð¸ÐºÐ°ÑŽÑ‚ÑŒ Ñ‡ÐµÑ€ÐµÐ· 10 Ñ…Ð²Ð¸Ð»Ð¸Ð½
        MAX_SIGNALS_ON_SITE: '6'       # ÐœÐ°ÐºÑ 6 ÑÐ¸Ð³Ð½Ð°Ð»Ñ–Ð² Ð½Ð° ÑÐ°Ð¹Ñ‚Ñ–
        ASSETS: 'GBPJPY_otc,EURUSD_otc,USDJPY_otc'
        TIMEFRAMES: '120'
        LOG_LEVEL: 'INFO'
        GROQ_MODEL: 'openai/gpt-oss-120b'
        LANGUAGE: ${{ inputs.language || 'uk' }}
        TRIGGER_SOURCE: ${{ inputs.trigger_source || 'manual' }}
      run: |
        echo "ðŸš€ ÐŸÐžÐ§ÐÐ¢ÐžÐš Ð“Ð•ÐÐ•Ð ÐÐ¦Ð†Ð‡ Ð¡Ð˜Ð“ÐÐÐ›Ð†Ð’"
        echo "â° Ð—Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ð·Ð° Ñ€Ð¾Ð·ÐºÐ»Ð°Ð´Ð¾Ð¼: $(date '+%Y-%m-%d %H:%M:%S') UTC"
        echo "ðŸ“… ÐÐ°ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº: Ñ‡ÐµÑ€ÐµÐ· 10 Ñ…Ð²Ð¸Ð»Ð¸Ð½ (Ñƒ :00, :10, :20, :30, :40, :50)"
        echo "ðŸŒ ÐœÐ¾Ð²Ð°: $LANGUAGE"
        echo "ðŸ“Š ÐÐºÑ‚Ð¸Ð²Ð¸: $ASSETS"
        echo "ðŸ§  ÐœÐ¾Ð´ÐµÐ»ÑŒ AI: $GROQ_MODEL"
        echo "ðŸ• Ð§Ð°ÑÐ¾Ð²Ð¸Ð¹ Ð¿Ð¾ÑÑ: ÐšÐ¸Ñ—Ð² (UTC+2)"
        echo "ðŸ”§ Ð”Ð¶ÐµÑ€ÐµÐ»Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÑƒ: $TRIGGER_SOURCE"
        echo "â±ï¸  Ð†Ð½Ñ‚ÐµÑ€Ð²Ð°Ð» Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ—: 10 Ñ…Ð²Ð¸Ð»Ð¸Ð½"
        echo "ðŸ“ˆ Ð¡Ð¸Ð³Ð½Ð°Ð»Ñ–Ð² Ð½Ð° ÑÐ°Ð¹Ñ‚Ñ–: Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 6"
        
        # Ð”Ð¾Ð´Ð°Ñ‚ÐºÐ¾Ð²Ðµ Ð»Ð¾Ð³ÑƒÐ²Ð°Ð½Ð½Ñ Ð´Ð»Ñ Ð´ÐµÐ±Ð°Ð³Ñƒ
        echo "ðŸ“‹ ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ñ‡Ð°ÑÑƒ:"
        date
        echo "Ð¢Ð°Ð¹Ð¼Ð·Ð¾Ð½Ð°:"
        timedatectl status 2>/dev/null || echo "Timedatectl Ð½Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹"
        
        export PYTHONPATH=$PYTHONPATH:$(pwd)/backend:$(pwd):$(pwd)/utils
        
        cd backend
        python signal_generator.py
        
        echo "âœ… Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ ÑÐ¸Ð³Ð½Ð°Ð»Ñ–Ð² Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
        echo "ðŸ• Ð§Ð°Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð½Ñ: $(date '+%H:%M:%S') UTC"
    
    - name: Commit and push all changes
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
        # Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ Ð²ÑÑ– Ð·Ð¼Ñ–Ð½Ð¸ Ð² Ð´Ð°Ð½Ð¸Ñ…
        git add data/
        git add logs/
        git add .nojekyll
        
        if git diff --staged --quiet; then
          echo "âš ï¸ ÐÐµÐ¼Ð°Ñ” Ð·Ð¼Ñ–Ð½ Ð´Ð»Ñ ÐºÐ¾Ð¼Ñ–Ñ‚Ñƒ"
        else
          git commit -m "ðŸ¤– Ð¡Ð¸Ð³Ð½Ð°Ð»Ð¸: $(date +'%Y-%m-%d %H:%M') [ÐœÐ¾Ð²Ð°: ${{ inputs.language || 'uk' }}] [Auto]"
          git push origin main
          echo "âœ… Ð—Ð¼Ñ–Ð½Ð¸ Ð·Ð°ÐºÐ¾Ð¼Ñ–Ñ‡ÐµÐ½Ð¾ Ñ‚Ð° Ð²Ñ–Ð´Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾"
          echo "ðŸ“¤ Ð—Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾ Ð¿ÑƒÑˆ Ð· Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¼Ð¸ ÑÐ¸Ð³Ð½Ð°Ð»Ð°Ð¼Ð¸"
        fi
    
    - name: Log completion time
      run: |
        echo "ðŸ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° Ð¾ $(date '+%H:%M:%S') UTC"
        echo "â³ ÐÐ°ÑÑ‚ÑƒÐ¿Ð½Ð° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ Ñ‡ÐµÑ€ÐµÐ· 10 Ñ…Ð²Ð¸Ð»Ð¸Ð½ (Ñƒ :00, :10, :20, :30, :40, :50)"
        echo "ðŸ“Š Ð”Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸: Ð¿ÐµÑ€ÐµÐ¹Ð´Ñ–Ñ‚ÑŒ Ñƒ Actions -> signals.yml"
