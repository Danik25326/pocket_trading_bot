name: Generate Trading Signals

on:
  workflow_dispatch:
    inputs:
      language:
        description: '–ú–æ–≤–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Å–∏–≥–Ω–∞–ª—ñ–≤'
        required: true
        default: 'uk'
        type: choice
        options:
          - uk
          - ru
      trigger_source:
        description: '–î–∂–µ—Ä–µ–ª–æ –∑–∞–ø—É—Å–∫—É'
        default: 'manual'
        type: string
  schedule:
    - cron: '*/10 * * * *'  # –ß—ñ—Ç–∫–æ –∫–æ–∂–Ω—ñ 10 —Ö–≤–∏–ª–∏–Ω

permissions:
  contents: write

jobs:
  generate-signals:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Debug SSID length
      env:
        POCKET_SSID: ${{ secrets.POCKET_SSID }}
      run: |
        echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ SSID:"
        echo "SSID length: ${#POCKET_SSID}"
        echo "First 50 chars: ${POCKET_SSID:0:50}"
        echo "Last 50 chars: ${POCKET_SSID: -50}"
        echo "Full SSID: ${POCKET_SSID}"
    
    - name: Clear all caches
      run: |
        echo "üßπ –û—á–∏—â–µ–Ω–Ω—è –∫–µ—à—É..."
        pip cache purge
        rm -rf ~/.cache/pip
        rm -rf ~/.cache/apt
        sudo apt-get clean
        echo "‚úÖ –ö–µ—à –æ—á–∏—â–µ–Ω–æ"
    
    - name: Upgrade pip and install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install --no-cache-dir -r backend/requirements.txt
        echo "‚úÖ –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    
    - name: Create necessary directories
      run: |
        echo "üìÅ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π..."
        mkdir -p data
        mkdir -p logs
        touch .nojekyll
        
        # –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏, —è–∫—â–æ —ó—Ö –Ω–µ–º–∞—î
        if [ ! -f data/signals.json ]; then 
          echo '{"last_update": null, "signals": [], "timezone": "Europe/Kiev (UTC+2)"}' > data/signals.json
          echo "‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ signals.json"
        fi
        if [ ! -f data/history.json ]; then 
          echo '[]' > data/history.json
          echo "‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ history.json"
        fi
        if [ ! -f data/assets_config.json ]; then 
          echo '{"preferred_assets": ["GBPJPY_otc", "EURUSD_otc", "USDJPY_otc"]}' > data/assets_config.json
          echo "‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ assets_config.json"
        fi
        if [ ! -f data/lessons.json ]; then 
          echo '[]' > data/lessons.json
          echo "‚úÖ –°—Ç–≤–æ—Ä–µ–Ω–æ lessons.json"
        fi
    
    - name: Generate trading signals
      env:
        POCKET_SSID: ${{ secrets.POCKET_SSID }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        POCKET_DEMO: 'true'
        SIGNAL_INTERVAL: '600'  # 10 —Ö–≤–∏–ª–∏–Ω
        MIN_CONFIDENCE: '0.7'
        MAX_DURATION: '5.0'
        SIGNAL_VALIDITY_MINUTES: '10'  # –°–∏–≥–Ω–∞–ª–∏ –∑–Ω–∏–∫–∞—é—Ç—å —á–µ—Ä–µ–∑ 10 —Ö–≤–∏–ª–∏–Ω
        MAX_SIGNALS_ON_SITE: '6'       # –ú–∞–∫—Å 6 —Å–∏–≥–Ω–∞–ª—ñ–≤ –Ω–∞ —Å–∞–π—Ç—ñ
        ASSETS: 'GBPJPY_otc,EURUSD_otc,USDJPY_otc'
        TIMEFRAMES: '120'
        LOG_LEVEL: 'INFO'
        GROQ_MODEL: 'openai/gpt-oss-120b'
        LANGUAGE: ${{ inputs.language || 'uk' }}
        TRIGGER_SOURCE: ${{ inputs.trigger_source || 'manual' }}
      run: |
        echo "üöÄ –ü–û–ß–ê–¢–û–ö –ì–ï–ù–ï–†–ê–¶–Ü–á –°–ò–ì–ù–ê–õ–Ü–í"
        echo "‚è∞ –ó–∞–ø—É—â–µ–Ω–æ –∑–∞ —Ä–æ–∑–∫–ª–∞–¥–æ–º: $(date '+%Y-%m-%d %H:%M:%S') UTC"
        echo "üìÖ –ù–∞—Å—Ç—É–ø–Ω–∏–π –∑–∞–ø—É—Å–∫: —á–µ—Ä–µ–∑ 10 —Ö–≤–∏–ª–∏–Ω (—É :00, :10, :20, :30, :40, :50)"
        echo "üåê –ú–æ–≤–∞: $LANGUAGE"
        echo "üìä –ê–∫—Ç–∏–≤–∏: $ASSETS"
        echo "üß† –ú–æ–¥–µ–ª—å AI: $GROQ_MODEL"
        echo "üïê –ß–∞—Å–æ–≤–∏–π –ø–æ—è—Å: –ö–∏—ó–≤ (UTC+2)"
        echo "üîß –î–∂–µ—Ä–µ–ª–æ –∑–∞–ø—É—Å–∫—É: $TRIGGER_SOURCE"
        echo "‚è±Ô∏è  –Ü–Ω—Ç–µ—Ä–≤–∞–ª –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó: 10 —Ö–≤–∏–ª–∏–Ω"
        echo "üìà –°–∏–≥–Ω–∞–ª—ñ–≤ –Ω–∞ —Å–∞–π—Ç—ñ: –º–∞–∫—Å–∏–º—É–º 6"
        echo "üí∞ –†–µ–∂–∏–º: DEMO"
        
        # –î–æ–¥–∞—Ç–∫–æ–≤–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥–µ–±–∞–≥—É
        echo "üìã –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∞—Å—É:"
        date
        echo "–¢–∞–π–º–∑–æ–Ω–∞:"
        timedatectl status 2>/dev/null || echo "Timedatectl –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∏–π"
        
        # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ PYTHONPATH —Ç–∞ –∑–∞–ø—É—Å–∫–∞—î–º–æ –∑ –∫–æ—Ä–µ–Ω—è
        export PYTHONPATH=$PYTHONPATH:$(pwd)
        
        # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ –∫–æ—Ä—ñ–Ω—å –ø—Ä–æ–µ–∫—Ç—É —Ç–∞ –∑–∞–ø—É—Å–∫–∞—î–º–æ
        cd $(pwd)
        python backend/signal_generator.py
        
        echo "‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Å–∏–≥–Ω–∞–ª—ñ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        echo "üïê –ß–∞—Å –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è: $(date '+%H:%M:%S') UTC"
    
    - name: Verify generated files
      run: |
        echo "üìÅ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤:"
        ls -la data/
        echo "üìä signals.json content:"
        cat data/signals.json
        echo "üìà history.json content (–ø–µ—Ä—à—ñ 2 –∑–∞–ø–∏—Å—É):"
        jq '.[0:2]' data/history.json || head -20 data/history.json
        echo "‚úÖ –†–æ–∑–º—ñ—Ä signals.json: $(wc -c < data/signals.json) –±–∞–π—Ç"
        echo "‚úÖ –†–æ–∑–º—ñ—Ä history.json: $(wc -c < data/history.json) –±–∞–π—Ç"
    
    - name: Commit and push all changes
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑–º—ñ–Ω–∏ –≤ –¥–∞–Ω–∏—Ö
        echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–º—ñ–Ω —É —Ñ–∞–π–ª–∞—Ö..."
        git status
        
        # –î–æ–¥–∞—î–º–æ –≤—Å—ñ –∑–º—ñ–Ω–∏ –≤ –¥–∞–Ω–∏—Ö
        git add data/
        git add logs/
        git add .nojekyll
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∑–º—ñ–Ω–∏ –¥–ª—è –∫–æ–º—ñ—Ç—É
        if git diff --staged --quiet; then
          echo "‚ö†Ô∏è –ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è –∫–æ–º—ñ—Ç—É"
        else
          git commit -m "ü§ñ –°–∏–≥–Ω–∞–ª–∏: $(date +'%Y-%m-%d %H:%M') [–ú–æ–≤–∞: ${{ inputs.language || 'uk' }}] [Auto]"
          
          # –°–ø—Ä–æ–±—É—î–º–æ –∑–∞–ø—É—à–∏—Ç–∏ –∑–º—ñ–Ωs
          echo "üì§ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–º—ñ–Ω –¥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é..."
          attempts=3
          count=0
          success=false
          
          while [ $count -lt $attempts ]; do
            if git push origin main; then
              success=true
              break
            fi
            count=$((count+1))
            echo "‚ö†Ô∏è –°–ø—Ä–æ–±–∞ $count –Ω–µ –≤–¥–∞–ª–∞—Å—è, —á–µ–∫–∞—î–º–æ 5 —Å–µ–∫—É–Ω–¥..."
            sleep 5
          done
          
          if [ "$success" = true ]; then
            echo "‚úÖ –ó–º—ñ–Ω–∏ –∑–∞–∫–æ–º—ñ—á–µ–Ω–æ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ"
          else
            echo "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–º—ñ–Ω–∏ –ø—ñ—Å–ª—è $attempts —Å–ø—Ä–æ–±"
          fi
        fi
    
    - name: Log completion time
      run: |
        echo "üèÅ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –æ $(date '+%H:%M:%S') UTC"
        echo "‚è≥ –ù–∞—Å—Ç—É–ø–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è —á–µ—Ä–µ–∑ 10 —Ö–≤–∏–ª–∏–Ω (—É :00, :10, :20, :30, :40, :50)"
        echo "üìä –î–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏: –ø–µ—Ä–µ–π–¥—ñ—Ç—å —É Actions -> signals.yml"
        echo "üåê –î–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Å–∏–≥–Ω–∞–ª—ñ–≤: https://danik25326.github.io/pocket_trading_bot/"
        
        # –î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è
        echo "üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
        if [ -f data/signals.json ]; then
          total_signals=$(jq '.signals | length' data/signals.json 2>/dev/null || echo "0")
          active_signals=$(jq '.active_signals' data/signals.json 2>/dev/null || echo "0")
          echo "   –°–∏–≥–Ω–∞–ª—ñ–≤ —É —Ñ–∞–π–ª—ñ: $total_signals"
          echo "   –ê–∫—Ç–∏–≤–Ω–∏—Ö —Å–∏–≥–Ω–∞–ª—ñ–≤: $active_signals"
        fi
