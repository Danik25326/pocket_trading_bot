
name: Generate and Deploy Trading Signals

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–æ–∂–Ω—ñ 5 —Ö–≤–∏–ª–∏–Ω
    - cron: '*/5 * * * *'
  
  workflow_dispatch:
    inputs:
      language:
        description: '–ú–æ–≤–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Å–∏–≥–Ω–∞–ª—ñ–≤'
        required: true
        default: 'uk'
        type: choice
        options:
          - uk
          - ru
      trigger_source:
        description: '–î–∂–µ—Ä–µ–ª–æ –∑–∞–ø—É—Å–∫—É'
        default: 'auto'
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-signals:
    runs-on: ubuntu-latest
    timeout-minutes: 4
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir -r backend/requirements.txt
    
    - name: Create necessary directories
      run: |
        mkdir -p data logs
        touch .nojekyll
        
        # –°—Ç–≤–æ—Ä—é—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—ñ —Ñ–∞–π–ª–∏
        if [ ! -f data/signals.json ]; then 
          echo '{"last_update": null, "signals": [], "timezone": "Europe/Kiev (UTC+2)"}' > data/signals.json
        fi
        if [ ! -f data/history.json ]; then 
          echo '[]' > data/history.json
        fi
        if [ ! -f data/assets_config.json ]; then 
          echo '{"preferred_assets": ["GBPJPY_otc", "EURUSD_otc", "USDJPY_otc"]}' > data/assets_config.json
        fi
        if [ ! -f data/usage.json ]; then 
          echo '{"date": "$(date +%Y-%m-%d)", "tokens_used": 0, "requests_used": 0, "last_reset": "$(date +%Y-%m-%d %H:%M:%S)"}' > data/usage.json
        fi
    
    - name: Check usage limits
      id: check_limits
      run: |
        echo "üìä –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª—ñ–º—ñ—Ç—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è..."
        python backend/check_limits.py
        echo "‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    - name: Generate trading signals
      if: steps.check_limits.outputs.can_generate == 'true'
      env:
        POCKET_SSID: ${{ secrets.POCKET_SSID }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        POCKET_DEMO: 'true'
        SIGNAL_INTERVAL: '300'
        MIN_CONFIDENCE: '0.7'
        MAX_DURATION: '5.0'
        MAX_SIGNALS_TO_SHOW: '6'
        ASSETS_PER_GENERATION: '2'
        ENTRY_DELAY_MINUTES: '2'
        ASSETS: 'GBPJPY_otc,EURUSD_otc,USDJPY_otc'
        TIMEFRAMES: '120'
        LOG_LEVEL: 'INFO'
        GROQ_MODEL: 'openai/gpt-oss-120b'
        LANGUAGE: ${{ inputs.language || 'uk' }}
        TRIGGER_SOURCE: ${{ github.event_name == 'schedule' && 'auto' || inputs.trigger_source || 'manual' }}
        MAX_TOKENS_PER_DAY: '200000'
        MAX_REQUESTS_PER_DAY: '1000'
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Å–∏–≥–Ω–∞–ª—ñ–≤..."
        echo "üìä –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:"
        echo "   ‚Ä¢ –ú–æ–≤–∞: $LANGUAGE"
        echo "   ‚Ä¢ –õ—ñ–º—ñ—Ç —Å–∏–≥–Ω–∞–ª—ñ–≤: $MAX_SIGNALS_TO_SHOW"
        echo "   ‚Ä¢ –ó–∞—Ç—Ä–∏–º–∫–∞ –≤—Ö–æ–¥—É: $ENTRY_DELAY_MINUTES —Ö–≤"
        echo "   ‚Ä¢ –ê–∫—Ç–∏–≤–∏ –∑–∞ —Ä–∞–∑: $ASSETS_PER_GENERATION"
        
        export PYTHONPATH=$PYTHONPATH:$(pwd)/backend:$(pwd)
        
        cd backend
        python signal_generator.py
        
        echo "‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    - name: Deploy to GitHub Pages
      if: steps.check_limits.outputs.can_generate == 'true'
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
        git add data/
        git add logs/
        git add .nojekyll
        
        if git diff --staged --quiet; then
          echo "‚ö†Ô∏è –ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è –∫–æ–º—ñ—Ç—É"
        else
          git commit -m "ü§ñ –ê–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü—ñ—è: $(date +'%Y-%m-%d %H:%M') [–ú–æ–≤–∞: ${{ inputs.language || 'uk' }}] [skip ci]"
          git push origin main
          echo "‚úÖ –ó–º—ñ–Ω–∏ –∑–∞–∫–æ–º—ñ—á–µ–Ω–æ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ"
        fi
    
    - name: Skip generation
      if: steps.check_limits.outputs.can_generate == 'false'
      run: |
        echo "‚è∏Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü—ñ—é –ø—Ä–æ–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è –ª—ñ–º—ñ—Ç—ñ–≤"
        echo "üìä –î–µ—Ç–∞–ª—ñ:"
        echo "   ‚Ä¢ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ —Ç–æ–∫–µ–Ω—ñ–≤: ${{ steps.check_limits.outputs.tokens_used }}"
        echo "   ‚Ä¢ –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –∑–∞–ø–∏—Ç—ñ–≤: ${{ steps.check_limits.outputs.requests_used }}"
        echo "   ‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–∫–µ–Ω—ñ–≤: ${{ steps.check_limits.outputs.tokens_remaining }}"
        echo "   ‚Ä¢ –î–æ—Å—Ç—É–ø–Ω–æ –∑–∞–ø–∏—Ç—ñ–≤: ${{ steps.check_limits.outputs.requests_remaining }}"
    
    - name: Deploy to GitHub Pages
      if: steps.check_limits.outputs.can_generate == 'true'
      uses: actions/deploy-pages@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
