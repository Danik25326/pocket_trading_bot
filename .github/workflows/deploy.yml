name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'data/signals.json'
      - 'data/history.json'
      - 'index.html'
      - 'style.css'
      - 'script.js'
      - '.nojekyll'
      - 'backend/**'
      - 'utils/**'
      - '.github/workflows/**'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
    
    - name: Check for deployable changes
      id: check
      run: |
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∑–º—ñ–Ω–∏–ª–∏—Å—è —Ñ–∞–π–ª–∏ –¥–ª—è –¥–µ–ø–ª–æ—é
        echo "üìã –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–º—ñ–Ω –¥–ª—è –¥–µ–ø–ª–æ—é..."
        
        # –û—Ç—Ä–∏–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ –∑–º—ñ–Ω–µ–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤
        CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
        
        # –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª—ñ–≤, —è–∫—ñ –≤–∏–º–∞–≥–∞—é—Ç—å –¥–µ–ø–ª–æ—é
        DEPLOY_FILES="data/signals.json data/history.json index.html style.css script.js config.js .nojekyll"
        
        SHOULD_DEPLOY=false
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–∂–µ–Ω —Ñ–∞–π–ª
        for file in $DEPLOY_FILES; do
          if echo "$CHANGED_FILES" | grep -q "$file"; then
            echo "‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ –∑–º—ñ–Ω–∏ –≤ $file - –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–µ–ø–ª–æ–π"
            SHOULD_DEPLOY=true
          fi
        done
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑–º—ñ–Ω–∏ –≤ backend (–º–æ–∂—É—Ç—å –±—É—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ª–æ–≥—ñ–∫–∏)
        if echo "$CHANGED_FILES" | grep -q "^backend/"; then
          echo "‚úÖ –ó–Ω–∞–π–¥–µ–Ω–æ –∑–º—ñ–Ω–∏ –≤ backend - –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–µ–ø–ª–æ–π"
          SHOULD_DEPLOY=true
        fi
        
        if [ "$SHOULD_DEPLOY" = true ]; then
          echo "üöÄ –î–µ–ø–ª–æ–π –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π"
          echo "should_deploy=true" >> $GITHUB_OUTPUT
        else
          echo "‚è∏Ô∏è –ó–º—ñ–Ω–∏ –Ω–µ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –¥–µ–ø–ª–æ—é"
          echo "should_deploy=false" >> $GITHUB_OUTPUT
        fi

  deploy:
    needs: check-changes
    if: needs.check-changes.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Verify files exist
      run: |
        echo "üìÅ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ —Ñ–∞–π–ª—ñ–≤:"
        ls -la data/
        echo "‚úÖ signals.json: $(wc -l < data/signals.json) —Ä—è–¥–∫—ñ–≤"
        echo "‚úÖ history.json: $(wc -l < data/history.json) –∑–∞–ø–∏—Å—ñ–≤"
        echo "‚úÖ index.html: $(wc -l < index.html) —Ä—è–¥–∫—ñ–≤"
        echo "‚úÖ config.js:"
        cat config.js
      
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
        
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Log deployment
      run: |
        echo "üéâ –£—Å–ø—ñ—à–Ω–æ –∑–∞–¥–µ–ø–ª–æ–π–ª–µ–Ω–æ –Ω–∞ GitHub Pages!"
        echo "üåê URL: ${{ steps.deployment.outputs.page_url }}"
        echo "üïê –ß–∞—Å –¥–µ–ø–ª–æ—é: $(date '+%H:%M:%S') UTC"
