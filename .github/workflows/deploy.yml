name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
    paths:
      - 'data/signals.json'
      - 'data/history.json'
      - 'data/feedback.json'
      - 'data/lessons.json'
      - 'data/assets_config.json'
      - 'index.html'
      - 'style.css'
      - 'script.js'
      - '.nojekyll'
      - 'backend/**'
      - 'utils/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'ÐŸÑ€Ð¸Ð¼ÑƒÑÐ¾Ð²Ð¸Ð¹ Ð´ÐµÐ¿Ð»Ð¾Ð¹'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Pages
      uses: actions/configure-pages@v4
    
    - name: Verify files exist
      run: |
        echo "ðŸ“ ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð½Ð°ÑÐ²Ð½Ð¾ÑÑ‚Ñ– Ñ„Ð°Ð¹Ð»Ñ–Ð²:"
        ls -la data/
        
        if [ -f data/signals.json ]; then
          SIGNALS_COUNT=$(jq '.signals | length' data/signals.json 2>/dev/null || echo "0")
          echo "âœ… signals.json: $SIGNALS_COUNT ÑÐ¸Ð³Ð½Ð°Ð»Ñ–Ð²"
        else
          echo "âš ï¸ signals.json Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾, ÑÑ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾..."
          echo '{"last_update": null, "signals": [], "timezone": "Europe/Kiev (UTC+2)"}' > data/signals.json
        fi
        
        if [ -f data/history.json ]; then
          HISTORY_COUNT=$(jq 'length' data/history.json 2>/dev/null || echo "0")
          echo "âœ… history.json: $HISTORY_COUNT Ð·Ð°Ð¿Ð¸ÑÑ–Ð²"
        else
          echo '[]' > data/history.json
        fi
        
        echo "âœ… index.html: $(wc -l < index.html) Ñ€ÑÐ´ÐºÑ–Ð²"
        
        # ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÑÑ”Ð¼Ð¾ Ð²Ð¼Ñ–ÑÑ‚ signals.json
        echo "ðŸ“‹ Ð’Ð¼Ñ–ÑÑ‚ signals.json:"
        cat data/signals.json | jq '.last_update' || echo "ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ñ‚Ð¸ signals.json"
    
    - name: Create .nojekyll file
      run: |
        touch .nojekyll
        echo "âœ… Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð¾ .nojekyll"
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
    
    - name: Log deployment
      run: |
        echo "ðŸŽ‰ Ð£ÑÐ¿Ñ–ÑˆÐ½Ð¾ Ð·Ð°Ð´ÐµÐ¿Ð»Ð¾Ð¹Ð»ÐµÐ½Ð¾ Ð½Ð° GitHub Pages!"
        echo "ðŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ðŸ• Ð§Ð°Ñ Ð´ÐµÐ¿Ð»Ð¾ÑŽ: $(date '+%H:%M:%S') UTC"
        echo "ðŸ“… Ð§Ð°Ñ ÐšÐ¸Ñ—Ð²: $(TZ='Europe/Kiev' date '+%H:%M:%S')"
        
        # Ð”Ð¾Ð´Ð°Ñ”Ð¼Ð¾ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÑƒ Ð¾ÑÑ‚Ð°Ð½Ð½ÑŒÐ¾Ð³Ð¾ Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ
        if [ -f data/signals.json ]; then
          LAST_UPDATE=$(cat data/signals.json | jq -r '.last_update // empty')
          if [ -n "$LAST_UPDATE" ]; then
            echo "ðŸ”„ ÐžÑÑ‚Ð°Ð½Ð½Ñ” Ð¾Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÑÐ¸Ð³Ð½Ð°Ð»Ñ–Ð²: $LAST_UPDATE"
          else
            echo "âš ï¸ ÐÐµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ last_update Ð² signals.json"
          fi
        fi
        
        # Ð†Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ Ð¿Ñ€Ð¾ Ð²ÐµÑ€ÑÑ–ÑŽ
        echo "ðŸ“Š Ð’ÐµÑ€ÑÑ–Ñ: 3.0 | Ð ÑƒÑ‡Ð½Ð° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ñ–Ñ: Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°"
