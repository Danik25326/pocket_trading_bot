name: Generate Config File

on:
  push:
    branches: [main]
    paths:
      - 'config.template.js'
      - '.github/workflows/deploy-config.yml'
  workflow_dispatch:  # –†—É—á–Ω–∏–π –∑–∞–ø—É—Å–∫

jobs:
  generate-config:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Create config.js from template
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # –ß–∏—Ç–∞—î–º–æ —à–∞–±–ª–æ–Ω
          if [ -f config.template.js ]; then
            # –ó–∞–º—ñ–Ω—é—î–º–æ —Ç–æ–∫–µ–Ω —É —à–∞–±–ª–æ–Ω—ñ
            sed "s/{{GH_PAT}}/$GH_PAT/g" config.template.js > config.js
            echo "‚úÖ config.js –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –∑ —à–∞–±–ª–æ–Ω—É"
          else
            # –°—Ç–≤–æ—Ä—é—î–º–æ config.js –∑ –Ω—É–ª—è, —è–∫—â–æ —à–∞–±–ª–æ–Ω—É –Ω–µ–º–∞—î
            echo "// config.js - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ" > config.js
            echo "window.GH_CONFIG = {" >> config.js
            echo "    token: '${{ secrets.GH_PAT }}'," >> config.js
            echo "    owner: 'DimonFrontend'," >> config.js
            echo "    repo: 'pocket_trading_bot'," >> config.js
            echo "    workflowId: 'signals.yml'" >> config.js
            echo "};" >> config.js
            echo "‚úÖ config.js –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –∑ –Ω—É–ª—è"
          fi
          
          cat config.js
      
      - name: Commit and push config.js
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          
          git add config.js
          
          if git diff --staged --quiet; then
            echo "‚ö†Ô∏è –ù–µ–º–∞—î –∑–º—ñ–Ω –¥–ª—è –∫–æ–º—ñ—Ç—É"
          else
            git commit -m "ü§ñ –û–Ω–æ–≤–ª–µ–Ω–æ config.js –∑ —Ç–æ–∫–µ–Ω–æ–º GitHub [skip ci]"
            git push origin main
            echo "‚úÖ config.js –æ–Ω–æ–≤–ª–µ–Ω–æ —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ"
          fi
